# WebSocket Endpoint Installation Instructions

**Agent 3: Real-Time Infrastructure Engineer**

## Status

- ✅ WebSocket server created (`backend/websocket_server.py`)
- ✅ Import added to `backend/mcp_server.py`
- ⏳ WebSocket endpoint needs to be added manually

## WebSocket Endpoint Code

Add this WebSocket endpoint to `backend/mcp_server.py` after line 1780 (before the `/ws/quotes` endpoint):

```python
# WebSocket endpoint for real-time chart commands (Phase 2: Agent Control)
@app.websocket("/ws/chart-commands/{session_id}")
async def websocket_chart_commands(websocket: WebSocket, session_id: str):
    """
    WebSocket endpoint for real-time chart command streaming.
    
    Provides sub-100ms latency for chart commands generated by agent.
    Fallback to HTTP is available if WebSocket connection fails.
    
    Usage:
        const ws = new WebSocket('ws://localhost:8000/ws/chart-commands/abc123');
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'chart_command') {
                // Apply command to chart
                executeCommand(data.command);
            }
        };
    """
    await chart_streamer.connect(websocket, session_id)
    
    try:
        while True:
            # Keep connection alive and allow client to send heartbeat
            data = await websocket.receive_text()
            
            # Handle client messages (ping/pong, status requests)
            try:
                message = json.loads(data)
                if message.get("type") == "ping":
                    await websocket.send_json({
                        "type": "pong",
                        "timestamp": datetime.utcnow().isoformat()
                    })
                elif message.get("type") == "get_status":
                    info = chart_streamer.get_session_info(session_id)
                    await websocket.send_json({
                        "type": "status",
                        "info": info
                    })
            except json.JSONDecodeError:
                pass  # Ignore malformed messages
                
    except WebSocketDisconnect:
        chart_streamer.disconnect(websocket, session_id)
        logger.info(f"[WS] Chart commands client disconnected from session {session_id}")
    except Exception as e:
        chart_streamer.disconnect(websocket, session_id)
        logger.error(f"[WS] Chart commands WebSocket error for session {session_id}: {e}")
```

## Integration with Agent Orchestrator

To stream commands from the agent, add this to `backend/services/agent_orchestrator.py`:

### Import at top of file:
```python
from websocket_server import stream_chart_command
```

### After command generation (in `_build_chart_commands` or similar):
```python
# Stream commands in real-time if session_id available
if hasattr(self, 'current_session_id') and self.current_session_id:
    for cmd in commands:
        await stream_chart_command(
            session_id=self.current_session_id,
            command=cmd,
            command_type="chart_command"
        )
```

## Testing

### Test WebSocket Connection:
```bash
# Install wscat if needed: npm install -g wscat
wscat -c ws://localhost:8000/ws/chart-commands/test123
```

### Send Ping:
```json
{"type": "ping"}
```

### Expected Response:
```json
{
  "type": "pong",
  "timestamp": "2025-11-01T19:45:00.123456"
}
```

### Broadcast Test Command:
```python
# In Python REPL or script:
import asyncio
from backend.websocket_server import stream_chart_command

async def test():
    await stream_chart_command(
        session_id="test123",
        command="LOAD:AAPL"
    )

asyncio.run(test())
```

## Success Criteria

- ✅ WebSocket accepts connections on `/ws/chart-commands/{session_id}`
- ✅ Ping/pong heartbeat working
- ✅ Commands broadcast to all clients in session
- ✅ Dead connections automatically cleaned up
- ✅ Latency <100ms from command generation to client receipt

## Rollback

If issues occur:
1. Comment out the WebSocket endpoint
2. HTTP fallback will continue working
3. No breaking changes to existing functionality

