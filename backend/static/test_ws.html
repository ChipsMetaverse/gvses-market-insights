<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test - Same Origin</title>
    <style>
        body { background: #1a1a1a; color: #fff; font-family: monospace; padding: 20px; }
        button { padding: 10px; margin: 5px; background: #2792dc; color: white; border: none; cursor: pointer; }
        #log { background: #000; padding: 20px; border-radius: 4px; margin-top: 20px; height: 400px; overflow-y: auto; white-space: pre-wrap; }
        .error { color: #ff4444; }
        .success { color: #44ff44; }
        .info { color: #4444ff; }
    </style>
</head>
<body>
    <h1>WebSocket Test - Served from Backend (Port 8000)</h1>
    <p>Origin: <span id="origin"></span></p>
    <button onclick="runTest()">Run WebSocket Test</button>
    <button onclick="clearLog()">Clear</button>
    <div id="log"></div>
    
    <script>
        document.getElementById('origin').textContent = window.location.origin;
        let websocket = null;
        
        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${new Date().toISOString().substring(11, 23)}] ${msg}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function runTest() {
            clearLog();
            log('Starting test from origin: ' + window.location.origin, 'info');
            
            try {
                // Get signed URL from same origin
                log('Fetching signed URL...', 'info');
                const response = await fetch('/elevenlabs/signed-url?agent_id=agent_4901k2tkkq54f4mvgpndm3pgzm7g');
                const data = await response.json();
                const signedUrl = data.signed_url;
                log('‚úÖ Got signed URL: ' + signedUrl.substring(0, 100) + '...', 'success');
                
                // Connect WebSocket
                log('Creating WebSocket...', 'info');
                websocket = new WebSocket(signedUrl);
                
                websocket.onopen = () => {
                    log('‚úÖ WebSocket opened!', 'success');
                    log('  State: ' + websocket.readyState, 'info');
                    log('  URL: ' + websocket.url.substring(0, 100) + '...', 'info');
                    
                    // Send init
                    const init = {
                        type: 'conversation_initiation_client_data',
                        custom_llm_extra_body: {}
                    };
                    log('Sending init: ' + JSON.stringify(init), 'info');
                    websocket.send(JSON.stringify(init));
                    log('‚úÖ Init sent', 'success');
                };
                
                websocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        log('üì• Message: ' + data.type, 'success');
                        if (data.type === 'conversation_initiation_metadata') {
                            log('üéâ SUCCESS! Conversation initialized!', 'success');
                            log('  ID: ' + data.conversation_id, 'success');
                        }
                    } catch (e) {
                        log('üì• Non-JSON: ' + event.data, 'info');
                    }
                };
                
                websocket.onerror = (error) => {
                    log('‚ùå WebSocket error', 'error');
                    log('  Type: ' + error.type, 'error');
                    log('  State: ' + websocket?.readyState, 'error');
                };
                
                websocket.onclose = (event) => {
                    log('‚ö†Ô∏è WebSocket closed', 'error');
                    log('  Code: ' + event.code, 'error');
                    log('  Reason: ' + event.reason, 'error');
                    log('  Clean: ' + event.wasClean, 'error');
                    
                    const codes = {
                        1000: 'Normal',
                        1001: 'Going away',
                        1006: 'Abnormal (no close frame)',
                        1015: 'TLS failure'
                    };
                    log('  Meaning: ' + (codes[event.code] || 'Unknown'), 'error');
                };
                
            } catch (error) {
                log('‚ùå Error: ' + error.message, 'error');
            }
        }
        
        log('Test page ready. Click "Run WebSocket Test" to begin.', 'info');
    </script>
</body>
</html>