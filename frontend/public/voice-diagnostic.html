<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Voice Pipeline Diagnostic v2.0</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .content {
      padding: 30px;
    }

    .status-bar {
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .status-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .status-item:last-child {
      border-bottom: none;
    }

    .status-icon {
      font-size: 24px;
      margin-right: 12px;
      width: 32px;
      text-align: center;
    }

    .status-text {
      flex: 1;
    }

    .status-label {
      font-weight: 600;
      margin-bottom: 4px;
      color: #2d3748;
    }

    .status-detail {
      font-size: 13px;
      color: #718096;
    }

    .button-group {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }

    .btn {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #2d3748;
    }

    .btn-secondary:hover {
      background: #cbd5e0;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .results {
      background: #f7fafc;
      border-radius: 8px;
      padding: 20px;
      margin-top: 24px;
      max-height: 400px;
      overflow-y: auto;
    }

    .result-item {
      background: white;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
      border-left: 4px solid #cbd5e0;
    }

    .result-item.pass {
      border-left-color: #48bb78;
    }

    .result-item.fail {
      border-left-color: #f56565;
    }

    .result-item.skip {
      border-left-color: #ed8936;
    }

    .result-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .result-stage {
      font-weight: 700;
      margin-right: 8px;
      color: #2d3748;
    }

    .result-name {
      flex: 1;
      font-weight: 600;
      color: #2d3748;
    }

    .result-status {
      font-size: 20px;
    }

    .result-message {
      font-size: 13px;
      color: #718096;
      margin-top: 4px;
    }

    .result-duration {
      font-size: 11px;
      color: #a0aec0;
      margin-top: 4px;
    }

    .summary {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      border-radius: 8px;
      padding: 20px;
      margin-top: 24px;
      text-align: center;
    }

    .summary.error {
      background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
    }

    .summary h3 {
      font-size: 20px;
      margin-bottom: 12px;
    }

    .summary p {
      opacity: 0.9;
      line-height: 1.6;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .info-box {
      background: #ebf8ff;
      border: 1px solid #90cdf4;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
    }

    .info-box h3 {
      color: #2c5282;
      margin-bottom: 8px;
      font-size: 16px;
    }

    .info-box p {
      color: #2d3748;
      font-size: 14px;
      line-height: 1.6;
    }

    .info-box code {
      background: #2d3748;
      color: #68d391;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéôÔ∏è Voice Pipeline Diagnostic</h1>
      <p>Automated testing for OpenAI Realtime API integration</p>
      <p style="font-size: 12px; margin-top: 8px; opacity: 0.8;">Version 2.0 ‚Ä¢ Updated: <span id="pageLoadTime"></span></p>
    </div>

    <div class="content">
      <div class="info-box">
        <h3>üìã Quick Start</h3>
        <p>This tool tests all components of the voice pipeline automatically. Click <strong>"Run Full Diagnostic"</strong> to verify backend connection, microphone availability, WebSocket support, and agent integration. Results will show which stages pass or fail.</p>
      </div>

      <div class="button-group">
        <button class="btn btn-primary" onclick="runDiagnostic()" id="runBtn">
          <span id="btnIcon">üß™</span>
          <span id="btnText">Run Full Diagnostic</span>
        </button>
        <button class="btn btn-secondary" onclick="clearResults()">
          üóëÔ∏è Clear Results
        </button>
      </div>

      <div class="status-bar">
        <div class="status-item">
          <div class="status-icon">üåê</div>
          <div class="status-text">
            <div class="status-label">Backend Status</div>
            <div class="status-detail" id="backendStatus">Not checked</div>
          </div>
        </div>
        <div class="status-item">
          <div class="status-icon">üé§</div>
          <div class="status-text">
            <div class="status-label">Microphone</div>
            <div class="status-detail" id="micStatus">Not checked</div>
          </div>
        </div>
        <div class="status-item">
          <div class="status-icon">üîå</div>
          <div class="status-text">
            <div class="status-label">WebSocket Support</div>
            <div class="status-detail" id="wsStatus">Not checked</div>
          </div>
        </div>
        <div class="status-item">
          <div class="status-icon">ü§ñ</div>
          <div class="status-text">
            <div class="status-label">Agent Orchestrator</div>
            <div class="status-detail" id="agentStatus">Not checked</div>
          </div>
        </div>
      </div>

      <div id="resultsContainer" style="display:none;">
        <div class="results" id="results"></div>
      </div>

      <div id="summary" style="display:none;"></div>
    </div>
  </div>

  <script>
    // Set page load time on page load
    document.getElementById('pageLoadTime').textContent = new Date().toLocaleTimeString();

    async function runDiagnostic() {
      const btn = document.getElementById('runBtn');
      const btnIcon = document.getElementById('btnIcon');
      const btnText = document.getElementById('btnText');
      const resultsContainer = document.getElementById('resultsContainer');
      const resultsDiv = document.getElementById('results');
      const summaryDiv = document.getElementById('summary');

      // Reset UI
      btn.disabled = true;
      btnIcon.innerHTML = '<div class="spinner"></div>';
      btnText.textContent = 'Running Diagnostic...';
      resultsDiv.innerHTML = '';
      summaryDiv.style.display = 'none';
      resultsContainer.style.display = 'block';

      const results = [];

      try {
        // Stage 1: Environment
        await runStage(1, 'Environment Check', async () => {
          const isSecure = window.location.protocol === 'https:' ||
                           window.location.hostname === 'localhost';
          if (!isSecure) throw new Error('Must use HTTPS or localhost');
          return `Protocol: ${window.location.protocol}`;
        }, results);

        // Stage 2: Backend Health
        await runStage(2, 'Backend Health', async () => {
          const apiUrl = 'http://localhost:8000';
          const res = await fetch(`${apiUrl}/health`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          if (data.status !== 'healthy') throw new Error('Backend unhealthy');
          if (!data.openai_relay_ready) throw new Error('OpenAI relay not ready');
          document.getElementById('backendStatus').textContent = `‚úÖ Healthy (${data.service_mode})`;
          return `Status: ${data.status}, Relay: ${data.openai_relay_ready}`;
        }, results);

        // Stage 3: OpenAI Realtime Relay Session
        await runStage(3, 'OpenAI Realtime Relay', async () => {
          const apiUrl = 'http://localhost:8000';
          console.log('üîç [STAGE 3] Fetching session from:', `${apiUrl}/openai/realtime/session`);
          const res = await fetch(`${apiUrl}/openai/realtime/session`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          console.log('üîç [STAGE 3] Response status:', res.status);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          console.log('üîç [STAGE 3] Response data:', data);
          console.log('üîç [STAGE 3] ws_url value:', data.ws_url);
          console.log('üîç [STAGE 3] Contains /realtime-relay/:', data.ws_url?.includes('/realtime-relay/'));
          if (!data.ws_url) throw new Error('No WebSocket URL returned');
          if (!data.ws_url.includes('/realtime-relay/')) throw new Error(`Invalid relay URL: ${data.ws_url}`);
          return `Session: ${data.session_id.substring(0, 20)}..., Status: ${data.status}`;
        }, results);

        // Stage 4: Microphone
        await runStage(4, 'Microphone Availability', async () => {
          if (!navigator.mediaDevices?.getUserMedia) throw new Error('getUserMedia not supported');
          const devices = await navigator.mediaDevices.enumerateDevices();
          const mics = devices.filter(d => d.kind === 'audioinput');
          if (mics.length === 0) throw new Error('No microphone found');
          document.getElementById('micStatus').textContent = `‚úÖ ${mics.length} device(s) found`;
          return `Found ${mics.length} microphone(s)`;
        }, results);

        // Stage 5: AudioContext
        await runStage(5, 'AudioContext Support', async () => {
          if (typeof AudioContext === 'undefined') throw new Error('AudioContext not supported');
          const ctx = new AudioContext({ sampleRate: 24000 });
          const state = ctx.state;
          await ctx.close();
          return `AudioContext available, state: ${state}`;
        }, results);

        // Stage 6: WebSocket
        await runStage(6, 'WebSocket Support', async () => {
          if (typeof WebSocket === 'undefined') throw new Error('WebSocket not supported');
          document.getElementById('wsStatus').textContent = '‚úÖ Supported';
          return 'WebSocket API available';
        }, results);

        // Stage 7: Agent Orchestrator
        await runStage(7, 'Agent Orchestrator', async () => {
          const apiUrl = 'http://localhost:8000';
          console.log('üîç [STAGE 7] Testing agent at:', `${apiUrl}/ask`);
          const res = await fetch(`${apiUrl}/ask`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: 'ping', conversation_history: [] })
          });
          console.log('üîç [STAGE 7] Response status:', res.status);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          console.log('üîç [STAGE 7] Response data:', data);
          // Backend returns "response" field, not "text"
          const responseText = data.response || data.text;
          if (!responseText) throw new Error('No response text');
          const toolCount = Object.keys(data.tool_results || {}).length;
          document.getElementById('agentStatus').textContent = `‚úÖ Responding (${toolCount} tools)`;
          return `Agent responding, tools: ${toolCount}`;
        }, results);

        // Summary
        const passed = results.filter(r => r.status === 'pass').length;
        const failed = results.filter(r => r.status === 'fail').length;

        summaryDiv.className = failed === 0 ? 'summary' : 'summary error';
        summaryDiv.innerHTML = failed === 0
          ? `<h3>‚úÖ All Checks Passed!</h3><p>Voice pipeline is ready. Click the <strong>üéôÔ∏è button</strong> in the main app and say:<br><code>"What is the price of Tesla?"</code></p>`
          : `<h3>‚ùå ${failed} Check(s) Failed</h3><p>Please fix the failed stages before testing voice functionality.</p>`;
        summaryDiv.style.display = 'block';

      } catch (error) {
        console.error('Diagnostic error:', error);
      }

      // Restore button
      btn.disabled = false;
      btnIcon.textContent = 'üß™';
      btnText.textContent = 'Run Full Diagnostic';
    }

    async function runStage(stage, name, test, results) {
      const startTime = Date.now();
      const resultsDiv = document.getElementById('results');

      try {
        const message = await test();
        const duration = Date.now() - startTime;

        results.push({ stage, name, status: 'pass', message, duration });

        resultsDiv.innerHTML += `
          <div class="result-item pass">
            <div class="result-header">
              <span class="result-stage">Stage ${stage}</span>
              <span class="result-name">${name}</span>
              <span class="result-status">‚úÖ</span>
            </div>
            <div class="result-message">${message}</div>
            <div class="result-duration">${duration}ms</div>
          </div>
        `;
      } catch (error) {
        const duration = Date.now() - startTime;

        results.push({ stage, name, status: 'fail', message: error.message, duration });

        resultsDiv.innerHTML += `
          <div class="result-item fail">
            <div class="result-header">
              <span class="result-stage">Stage ${stage}</span>
              <span class="result-name">${name}</span>
              <span class="result-status">‚ùå</span>
            </div>
            <div class="result-message">Error: ${error.message}</div>
            <div class="result-duration">${duration}ms</div>
          </div>
        `;

        throw error; // Stop further stages
      }
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
      document.getElementById('summary').style.display = 'none';
      document.getElementById('resultsContainer').style.display = 'none';
      document.getElementById('backendStatus').textContent = 'Not checked';
      document.getElementById('micStatus').textContent = 'Not checked';
      document.getElementById('wsStatus').textContent = 'Not checked';
      document.getElementById('agentStatus').textContent = 'Not checked';
    }
  </script>
</body>
</html>
